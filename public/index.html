<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACE å­¸ç¿’è€…åœ–è¡¨å ±å‘Šç³»çµ±</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.1);
      --radius: 12px;
      --radius-sm: 8px;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --bg-card: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Noto Sans TC', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-lg);
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .icon-btn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-btn:hover { background: rgba(255,255,255,0.25); }

    /* Navigation */
    .nav {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 0;
      padding: 0 2rem;
    }

    .nav-item {
      padding: 1rem 1.5rem;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover { color: var(--primary); }
    .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

    /* Main */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page { display: none; }
    .page.active { display: block; }

    /* Card */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    .card-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-body { padding: 1.5rem; }

    /* Steps */
    .steps {
      display: flex;
      margin-bottom: 2rem;
      position: relative;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: var(--border);
    }

    .step:last-child::before { display: none; }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--border);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
      transition: all 0.3s;
    }

    .step.active .step-number {
      background: var(--primary);
      color: white;
    }

    .step.completed .step-number {
      background: var(--success);
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .step.active .step-label { color: var(--text); font-weight: 500; }

    /* Time Tabs */
    .time-tabs {
      display: flex;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 4px;
      margin-bottom: 1rem;
    }

    .time-tab {
      flex: 1;
      padding: 0.75rem 1rem;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .time-tab:hover { color: var(--text); }
    .time-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }

    /* Selection Grid */
    .selection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .quick-actions {
      display: flex;
      gap: 0.5rem;
    }

    .quick-btn {
      padding: 0.375rem 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-muted);
      border-radius: 6px;
      font-size: 0.813rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-btn:hover { border-color: var(--primary); color: var(--primary); }

    .selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.5rem;
      max-height: 280px;
      overflow-y: auto;
      padding: 0.5rem;
      background: var(--bg);
      border-radius: var(--radius-sm);
    }

    .selection-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 0.75rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
    }

    .selection-item:hover { border-color: var(--primary); }
    .selection-item.selected { background: #eff6ff; border-color: var(--primary); color: var(--primary); }
    [data-theme="dark"] .selection-item.selected { background: #1e3a5f; }

    .selection-item input { display: none; }

    .checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .selection-item.selected .checkbox {
      background: var(--primary);
      border-color: var(--primary);
    }

    .checkbox::after {
      content: 'âœ“';
      color: white;
      font-size: 12px;
      opacity: 0;
    }

    .selection-item.selected .checkbox::after { opacity: 1; }

    /* Chart Table */
    .chart-table {
      width: 100%;
      border-collapse: collapse;
    }

    .chart-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      background: var(--bg);
      font-weight: 500;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .chart-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .chart-table tr:hover td { background: var(--bg); }

    .chart-name {
      font-weight: 500;
    }

    .chart-desc {
      font-size: 0.813rem;
      color: var(--text-muted);
    }

    .chart-checkbox {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.938rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { background: var(--secondary); cursor: not-allowed; }

    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover { background: var(--border); }

    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: white; }

    .btn-lg { padding: 1rem 2rem; font-size: 1rem; }

    /* Action Bar */
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      bottom: 1rem;
      margin-top: 1.5rem;
    }

    .selection-summary {
      display: flex;
      gap: 1.5rem;
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .summary-badge {
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    /* Charts Container */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 1.5rem;
    }

    .chart-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }

    .chart-card h3 {
      margin-bottom: 1rem;
      font-size: 1rem;
      font-weight: 600;
    }

    .chart-wrapper {
      position: relative;
      height: 350px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      background: var(--text);
      color: var(--bg);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.success { background: var(--success); color: white; }
    .toast.error { background: var(--danger); color: white; }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Contact Form */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      background: var(--bg-card);
      color: var(--text);
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea { min-height: 120px; resize: vertical; }

    /* Responsive */
    @media (max-width: 768px) {
      .header { padding: 1rem; }
      .header h1 { font-size: 1.25rem; }
      .nav { padding: 0 1rem; overflow-x: auto; }
      .nav-item { padding: 0.75rem 1rem; white-space: nowrap; }
      .main { padding: 1rem; }
      .steps { flex-direction: column; gap: 1rem; }
      .step::before { display: none; }
      .charts-container { grid-template-columns: 1fr; }
      .action-bar { flex-direction: column; gap: 1rem; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ“Š ACE å­¸ç¿’è€…åœ–è¡¨å ±å‘Šç³»çµ±</h1>
    <div class="header-actions">
      <button class="icon-btn" id="theme-toggle" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ™</button>
      <button class="icon-btn" id="lang-toggle" title="åˆ‡æ›èªè¨€">EN</button>
    </div>
  </header>

  <nav class="nav">
    <a class="nav-item active" data-page="home">é¦–é </a>
    <a class="nav-item" data-page="guide">æ“ä½œèªªæ˜</a>
    <a class="nav-item" data-page="contact">è¯çµ¡æˆ‘å€‘</a>
  </nav>

  <main class="main">
    <!-- é¦–é  -->
    <div id="page-home" class="page active">
      <!-- æ­¥é©ŸæŒ‡ç¤º -->
      <div class="steps">
        <div class="step active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-label">é¸æ“‡æ™‚é–“</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-label">é¸æ“‡åœ–è¡¨</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-label">ç”Ÿæˆå ±å‘Š</div>
        </div>
      </div>

      <!-- æ™‚é–“é¸æ“‡ -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“… é¸æ“‡æ™‚é–“ç¯„åœ</h2>
        </div>
        <div class="card-body">
          <div class="time-tabs">
            <button class="time-tab active" data-mode="month">æœˆä»½</button>
            <button class="time-tab" data-mode="semester">å­¸æœŸ</button>
            <button class="time-tab" data-mode="year">å­¸å¹´åº¦</button>
          </div>

          <div class="selection-header">
            <span id="time-hint">è«‹é¸æ“‡æœˆä»½ï¼ˆå¯å¤šé¸ï¼‰</span>
            <div class="quick-actions">
              <button class="quick-btn" id="select-all-time">å…¨é¸</button>
              <button class="quick-btn" id="select-none-time">å–æ¶ˆå…¨é¸</button>
              <button class="quick-btn" id="select-recent">æœ€è¿‘ä¸€å¹´</button>
            </div>
          </div>

          <div class="selection-grid" id="time-grid">
            <div class="loading">
              <div class="spinner"></div>
              <span>è¼‰å…¥ä¸­...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- åœ–è¡¨é¸æ“‡ -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“ˆ é¸æ“‡åœ–è¡¨é¡å‹</h2>
          <div class="quick-actions">
            <button class="quick-btn" id="select-all-new">å…¨é¸æ–°å¢</button>
            <button class="quick-btn" id="select-all-cum">å…¨é¸ç´¯è¨ˆ</button>
            <button class="quick-btn" id="select-none-chart">å–æ¶ˆå…¨é¸</button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          <table class="chart-table">
            <thead>
              <tr>
                <th style="width: 40%;">åœ–è¡¨åç¨±</th>
                <th style="width: 30%;">èªªæ˜</th>
                <th style="width: 15%; text-align: center;">æ–°å¢äººæ•¸</th>
                <th style="width: 15%; text-align: center;">ç´¯è¨ˆäººæ•¸</th>
              </tr>
            </thead>
            <tbody id="chart-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- æ“ä½œåˆ— -->
      <div class="action-bar">
        <div class="selection-summary">
          <div class="summary-item">
            <span>å·²é¸æ™‚é–“ï¼š</span>
            <span class="summary-badge" id="time-count">0</span>
          </div>
          <div class="summary-item">
            <span>å·²é¸åœ–è¡¨ï¼š</span>
            <span class="summary-badge" id="chart-count">0</span>
          </div>
        </div>
        <div style="display: flex; gap: 0.75rem;">
          <button class="btn btn-secondary" id="btn-clear">æ¸…é™¤é¸æ“‡</button>
          <button class="btn btn-primary btn-lg" id="btn-generate">ğŸš€ ç”Ÿæˆåœ–è¡¨</button>
        </div>
      </div>

      <!-- åœ–è¡¨çµæœ -->
      <div id="charts-result" style="display: none; margin-top: 2rem;">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“Š åœ–è¡¨çµæœ</h2>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-success" id="btn-download-pdf">ğŸ“¥ ä¸‹è¼‰ PDF</button>
              <button class="btn btn-warning" id="btn-download-png">ğŸ–¼ï¸ ä¸‹è¼‰ PNG</button>
            </div>
          </div>
        </div>
        <div class="charts-container" id="charts-container"></div>
      </div>
    </div>

    <!-- æ“ä½œèªªæ˜ -->
    <div id="page-guide" class="page">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“– æ“ä½œèªªæ˜</h2>
        </div>
        <div class="card-body">
          <h3 style="margin-bottom: 1rem;">ä½¿ç”¨æ­¥é©Ÿ</h3>
          <ol style="padding-left: 1.5rem; line-height: 2;">
            <li><strong>é¸æ“‡æ™‚é–“ç¯„åœ</strong>ï¼šå¯æŒ‰æœˆä»½ã€å­¸æœŸæˆ–å­¸å¹´åº¦é¸æ“‡</li>
            <li><strong>é¸æ“‡åœ–è¡¨é¡å‹</strong>ï¼šå‹¾é¸è¦ç”Ÿæˆçš„åœ–è¡¨åŠæ•¸æ“šé¡å‹ï¼ˆæ–°å¢/ç´¯è¨ˆï¼‰</li>
            <li><strong>ç”Ÿæˆåœ–è¡¨</strong>ï¼šé»æ“Šã€Œç”Ÿæˆåœ–è¡¨ã€æŒ‰éˆ•</li>
            <li><strong>ä¸‹è¼‰å ±å‘Š</strong>ï¼šå¯ä¸‹è¼‰ PDF å ±å‘Šæˆ– PNG åœ–ç‰‡</li>
          </ol>

          <h3 style="margin: 2rem 0 1rem;">æ™‚é–“èªªæ˜</h3>
          <ul style="padding-left: 1.5rem; line-height: 2;">
            <li><strong>æœˆä»½</strong>ï¼šæŒ‰å–®æœˆé¸æ“‡</li>
            <li><strong>å­¸æœŸ</strong>ï¼šä¸Šå­¸æœŸï¼ˆ8æœˆ-éš”å¹´1æœˆï¼‰ã€ä¸‹å­¸æœŸï¼ˆ2æœˆ-7æœˆï¼‰</li>
            <li><strong>å­¸å¹´åº¦</strong>ï¼šå®Œæ•´å­¸å¹´ï¼ˆ8æœˆ-éš”å¹´7æœˆï¼‰</li>
          </ul>

          <h3 style="margin: 2rem 0 1rem;">åœ–è¡¨é¡å‹</h3>
          <table class="chart-table" style="margin-top: 1rem;">
            <thead><tr><th>åœ–è¡¨</th><th>èªªæ˜</th></tr></thead>
            <tbody>
              <tr><td>ç¸½å ±åäººæ•¸</td><td>æ‰€æœ‰å­¸ç¿’è€…çš„ç¸½æ•¸è®ŠåŒ–</td></tr>
              <tr><td>æ ¡å…§å¤–å ±åè€…</td><td>æ•™å¸«ã€å­¸ç”Ÿã€ç ”ç©¶å“¡ã€å…¶ä»–</td></tr>
              <tr><td>å°å¤§å ±åè€…</td><td>è‡ºå¤§æ•™å¸«ã€å­¸ç”Ÿã€ç ”ç©¶å“¡</td></tr>
              <tr><td>æ•™å¸«æ‰€æœ‰è·ç´š</td><td>å°ˆä»»ã€å…¼ä»»ã€å°ˆæ¡ˆã€è‡¨åºŠæ•™å¸«</td></tr>
              <tr><td>å°ˆä»»/å…¼ä»»/å°ˆæ¡ˆ/è‡¨åºŠæ•™å¸«è·ç´š</td><td>æ•™æˆã€å‰¯æ•™æˆã€åŠ©ç†æ•™æˆã€è¬›å¸«</td></tr>
              <tr><td>å­¸ç”Ÿæ‰€æœ‰è·ç´š</td><td>å¤§å­¸ç”Ÿã€ç ”ç©¶ç”Ÿã€åšå£«ç”Ÿ</td></tr>
              <tr><td>æ•™å¸«/å­¸ç”Ÿå­¸é™¢</td><td>æŒ‰å­¸é™¢åˆ†é¡çš„åˆ†å¸ƒ</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- è¯çµ¡æˆ‘å€‘ -->
    <div id="page-contact" class="page">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“§ è¯çµ¡æˆ‘å€‘</h2>
        </div>
        <div class="card-body">
          <p style="margin-bottom: 1.5rem; color: var(--text-muted);">
            æ”¶ä»¶äººï¼š<a href="mailto:tingin0615@gmail.com" style="color: var(--primary);">tingin0615@gmail.com</a>
          </p>
          <form id="contact-form">
            <div class="form-group">
              <label>å§“å</label>
              <input type="text" id="contact-name" required>
            </div>
            <div class="form-group">
              <label>é›»å­éƒµä»¶</label>
              <input type="email" id="contact-email" required>
            </div>
            <div class="form-group">
              <label>ä¸»æ—¨</label>
              <input type="text" id="contact-subject" required>
            </div>
            <div class="form-group">
              <label>è¨Šæ¯å…§å®¹</label>
              <textarea id="contact-message" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">ğŸ“§ é€å‡ºè¨Šæ¯</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ==================== æ‡‰ç”¨ç¨‹å¼é¡åˆ¥ ====================
    class ACEDashboard {
      constructor() {
        this.state = {
          timeMode: 'month',
          timeOptions: { months: [], semesters: [], years: [] },
          selectedTimes: new Set(),
          selectedCharts: {},  // { chartId: { new: bool, cumulative: bool } }
          charts: [],
          theme: localStorage.getItem('theme') || 'light',
          lang: localStorage.getItem('lang') || 'zh'
        };

        this.chartConfigs = [
          { id: 'chart1', name: 'æ ¡å…§å¤–å ±åè€…', desc: 'æ•™å¸«ã€å­¸ç”Ÿã€ç ”ç©¶å“¡ã€å…¶ä»–' },
          { id: 'chart2', name: 'å°å¤§å ±åè€…', desc: 'è‡ºå¤§æ•™å¸«ã€å­¸ç”Ÿã€ç ”ç©¶å“¡' },
          { id: 'chart3', name: 'æ•™å¸«æ‰€æœ‰è·ç´š', desc: 'å°ˆä»»ã€å…¼ä»»ã€å°ˆæ¡ˆã€è‡¨åºŠ' },
          { id: 'chart4', name: 'å°ˆä»»æ•™å¸«è·ç´š', desc: 'æ•™æˆã€å‰¯æ•™æˆã€åŠ©ç†æ•™æˆã€è¬›å¸«' },
          { id: 'chart5', name: 'å…¼ä»»æ•™å¸«è·ç´š', desc: 'æ•™æˆã€å‰¯æ•™æˆã€åŠ©ç†æ•™æˆã€è¬›å¸«' },
          { id: 'chart6', name: 'å°ˆæ¡ˆæ•™å¸«è·ç´š', desc: 'æ•™æˆã€å‰¯æ•™æˆã€åŠ©ç†æ•™æˆã€è¬›å¸«' },
          { id: 'chart7', name: 'è‡¨åºŠæ•™å¸«è·ç´š', desc: 'æ•™æˆã€å‰¯æ•™æˆã€åŠ©ç†æ•™æˆã€è¬›å¸«' },
          { id: 'chart8', name: 'å­¸ç”Ÿæ‰€æœ‰è·ç´š', desc: 'å¤§å­¸ç”Ÿã€ç ”ç©¶ç”Ÿã€åšå£«ç”Ÿ' },
          { id: 'chart9', name: 'æ•™å¸«å­¸é™¢', desc: 'æŒ‰å­¸é™¢åˆ†é¡' },
          { id: 'chart10', name: 'å­¸ç”Ÿå­¸é™¢', desc: 'æŒ‰å­¸é™¢åˆ†é¡' },
          { id: 'chart11', name: 'æ•™å¸«èˆ‡å­¸ç”Ÿå­¸é™¢', desc: 'åˆä½µçµ±è¨ˆ' },
          { id: 'chart0', name: 'ç¸½å ±åäººæ•¸', desc: 'ç¸½æ•¸è®ŠåŒ–è¶¨å‹¢' }
        ];

        this.chartInstances = {};
        this.colors = [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
          '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
          '#14b8a6', '#eab308', '#dc2626', '#a855f7', '#0891b2',
          '#65a30d', '#ea580c', '#db2777', '#4f46e5', '#0d9488'
        ];

        this.init();
      }

      async init() {
        this.bindEvents();
        this.renderChartTable();
        this.applyTheme();
        await this.loadTimeOptions();
        this.updateSummary();
      }

      // ========== äº‹ä»¶ç¶å®š ==========
      bindEvents() {
        // å°èˆª
        document.querySelectorAll('.nav-item').forEach(item => {
          item.addEventListener('click', () => this.switchPage(item.dataset.page));
        });

        // ä¸»é¡Œåˆ‡æ›
        document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());

        // èªè¨€åˆ‡æ›
        document.getElementById('lang-toggle').addEventListener('click', () => this.toggleLang());

        // æ™‚é–“æ¨¡å¼åˆ‡æ›
        document.querySelectorAll('.time-tab').forEach(tab => {
          tab.addEventListener('click', () => this.switchTimeMode(tab.dataset.mode));
        });

        // å¿«é€Ÿæ“ä½œ - æ™‚é–“
        document.getElementById('select-all-time').addEventListener('click', () => this.selectAllTime());
        document.getElementById('select-none-time').addEventListener('click', () => this.selectNoneTime());
        document.getElementById('select-recent').addEventListener('click', () => this.selectRecentTime());

        // å¿«é€Ÿæ“ä½œ - åœ–è¡¨
        document.getElementById('select-all-new').addEventListener('click', () => this.selectAllCharts('new'));
        document.getElementById('select-all-cum').addEventListener('click', () => this.selectAllCharts('cumulative'));
        document.getElementById('select-none-chart').addEventListener('click', () => this.selectNoneCharts());

        // ç”ŸæˆæŒ‰éˆ•
        document.getElementById('btn-generate').addEventListener('click', () => this.generateCharts());
        document.getElementById('btn-clear').addEventListener('click', () => this.clearAll());

        // ä¸‹è¼‰æŒ‰éˆ•
        document.getElementById('btn-download-pdf').addEventListener('click', () => this.downloadPDF());
        document.getElementById('btn-download-png').addEventListener('click', () => this.downloadPNG());

        // è¯çµ¡è¡¨å–®
        document.getElementById('contact-form').addEventListener('submit', (e) => this.handleContact(e));
      }

      // ========== é é¢åˆ‡æ› ==========
      switchPage(page) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelector(`[data-page="${page}"]`).classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${page}`).classList.add('active');
      }

      // ========== ä¸»é¡Œ ==========
      toggleTheme() {
        this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', this.state.theme);
        this.applyTheme();
      }

      applyTheme() {
        document.documentElement.setAttribute('data-theme', this.state.theme);
        document.getElementById('theme-toggle').textContent = this.state.theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
      }

      // ========== èªè¨€ ==========
      toggleLang() {
        this.state.lang = this.state.lang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('lang', this.state.lang);
        document.getElementById('lang-toggle').textContent = this.state.lang === 'zh' ? 'EN' : 'ä¸­';
        // ç°¡åŒ–ï¼šåªæ›´æ–°æŒ‰éˆ•æ–‡å­—
      }

      // ========== è¼‰å…¥æ™‚é–“é¸é … ==========
      async loadTimeOptions() {
        try {
          const res = await fetch('/api/time-options');
          const json = await res.json();
          if (json.success) {
            this.state.timeOptions = json.data;
            this.renderTimeGrid();
          } else {
            this.useMockData();
          }
        } catch (e) {
          console.warn('ä½¿ç”¨æ¨¡æ“¬è³‡æ–™');
          this.useMockData();
        }
      }

      useMockData() {
        const now = new Date();
        const months = [];
        for (let i = 84; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          months.push(`${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`);
        }

        const semesters = new Set(), years = new Set();
        months.forEach(m => {
          const [y, mo] = m.split('-').map(Number);
          if (mo >= 8) { semesters.add(`${y - 1911}-1`); years.add((y - 1911).toString()); }
          else if (mo === 1) { semesters.add(`${y - 1912}-1`); }
          else { semesters.add(`${y - 1912}-2`); years.add((y - 1912).toString()); }
        });

        this.state.timeOptions = {
          months,
          semesters: [...semesters].sort(),
          years: [...years].sort()
        };
        this.renderTimeGrid();
      }

      // ========== æ¸²æŸ“æ™‚é–“é¸é … ==========
      renderTimeGrid() {
        const grid = document.getElementById('time-grid');
        const mode = this.state.timeMode;
        const hints = {
          month: 'è«‹é¸æ“‡æœˆä»½ï¼ˆå¯å¤šé¸ï¼‰',
          semester: 'è«‹é¸æ“‡å­¸æœŸï¼ˆä¸Šå­¸æœŸï¼š8æœˆ-1æœˆï¼Œä¸‹å­¸æœŸï¼š2æœˆ-7æœˆï¼‰',
          year: 'è«‹é¸æ“‡å­¸å¹´åº¦ï¼ˆ8æœˆ-éš”å¹´7æœˆï¼‰'
        };
        document.getElementById('time-hint').textContent = hints[mode];

        let items = [];
        if (mode === 'month') {
          items = this.state.timeOptions.months.map(m => ({ value: m, label: m }));
        } else if (mode === 'semester') {
          items = this.state.timeOptions.semesters.map(s => {
            const [y, sem] = s.split('-');
            return { value: s, label: `${y}å­¸å¹´ ${sem === '1' ? 'ä¸Š' : 'ä¸‹'}å­¸æœŸ` };
          });
        } else {
          items = this.state.timeOptions.years.map(y => ({ value: y, label: `${y}å­¸å¹´åº¦` }));
        }

        grid.innerHTML = items.map(item => `
          <label class="selection-item ${this.state.selectedTimes.has(item.value) ? 'selected' : ''}">
            <input type="checkbox" value="${item.value}" ${this.state.selectedTimes.has(item.value) ? 'checked' : ''}>
            <span class="checkbox"></span>
            <span>${item.label}</span>
          </label>
        `).join('');

        grid.querySelectorAll('.selection-item').forEach(item => {
          item.addEventListener('click', (e) => {
            if (e.target.tagName === 'INPUT') return;
            const input = item.querySelector('input');
            input.checked = !input.checked;
            this.toggleTimeSelection(input.value, input.checked);
          });

          item.querySelector('input').addEventListener('change', (e) => {
            this.toggleTimeSelection(e.target.value, e.target.checked);
          });
        });
      }

      toggleTimeSelection(value, selected) {
        if (selected) {
          this.state.selectedTimes.add(value);
        } else {
          this.state.selectedTimes.delete(value);
        }
        this.renderTimeGrid();
        this.updateSummary();
        this.updateSteps();
      }

      // ========== æ¸²æŸ“åœ–è¡¨è¡¨æ ¼ ==========
      renderChartTable() {
        const tbody = document.getElementById('chart-table-body');
        tbody.innerHTML = this.chartConfigs.map(c => `
          <tr>
            <td class="chart-name">${c.name}</td>
            <td class="chart-desc">${c.desc}</td>
            <td style="text-align: center;">
              <input type="checkbox" class="chart-checkbox" data-chart="${c.id}" data-type="new"
                ${this.state.selectedCharts[c.id]?.new ? 'checked' : ''}>
            </td>
            <td style="text-align: center;">
              <input type="checkbox" class="chart-checkbox" data-chart="${c.id}" data-type="cumulative"
                ${this.state.selectedCharts[c.id]?.cumulative ? 'checked' : ''}>
            </td>
          </tr>
        `).join('');

        tbody.querySelectorAll('.chart-checkbox').forEach(cb => {
          cb.addEventListener('change', (e) => {
            const { chart, type } = e.target.dataset;
            if (!this.state.selectedCharts[chart]) {
              this.state.selectedCharts[chart] = { new: false, cumulative: false };
            }
            this.state.selectedCharts[chart][type] = e.target.checked;
            this.updateSummary();
            this.updateSteps();
          });
        });
      }

      // ========== å¿«é€Ÿé¸æ“‡ ==========
      selectAllTime() {
        const mode = this.state.timeMode;
        const items = mode === 'month' ? this.state.timeOptions.months
          : mode === 'semester' ? this.state.timeOptions.semesters
          : this.state.timeOptions.years;
        this.state.selectedTimes = new Set(items);
        this.renderTimeGrid();
        this.updateSummary();
        this.updateSteps();
      }

      selectNoneTime() {
        this.state.selectedTimes.clear();
        this.renderTimeGrid();
        this.updateSummary();
        this.updateSteps();
      }

      selectRecentTime() {
        const mode = this.state.timeMode;
        let items = [];
        if (mode === 'month') {
          items = this.state.timeOptions.months.slice(-12);
        } else if (mode === 'semester') {
          items = this.state.timeOptions.semesters.slice(-2);
        } else {
          items = this.state.timeOptions.years.slice(-1);
        }
        this.state.selectedTimes = new Set(items);
        this.renderTimeGrid();
        this.updateSummary();
        this.updateSteps();
      }

      selectAllCharts(type) {
        this.chartConfigs.forEach(c => {
          if (!this.state.selectedCharts[c.id]) {
            this.state.selectedCharts[c.id] = { new: false, cumulative: false };
          }
          this.state.selectedCharts[c.id][type] = true;
        });
        this.renderChartTable();
        this.updateSummary();
        this.updateSteps();
      }

      selectNoneCharts() {
        this.state.selectedCharts = {};
        this.renderChartTable();
        this.updateSummary();
        this.updateSteps();
      }

      clearAll() {
        this.state.selectedTimes.clear();
        this.state.selectedCharts = {};
        this.renderTimeGrid();
        this.renderChartTable();
        this.updateSummary();
        this.updateSteps();
      }

      // ========== åˆ‡æ›æ™‚é–“æ¨¡å¼ ==========
      switchTimeMode(mode) {
        this.state.timeMode = mode;
        this.state.selectedTimes.clear();
        document.querySelectorAll('.time-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
        this.renderTimeGrid();
        this.updateSummary();
      }

      // ========== æ›´æ–°æ‘˜è¦ ==========
      updateSummary() {
        document.getElementById('time-count').textContent = this.state.selectedTimes.size;
        
        let chartCount = 0;
        Object.values(this.state.selectedCharts).forEach(c => {
          if (c.new) chartCount++;
          if (c.cumulative) chartCount++;
        });
        document.getElementById('chart-count').textContent = chartCount;
      }

      updateSteps() {
        const hasTime = this.state.selectedTimes.size > 0;
        const hasChart = Object.values(this.state.selectedCharts).some(c => c.new || c.cumulative);

        document.querySelectorAll('.step').forEach(s => {
          s.classList.remove('active', 'completed');
        });

        if (!hasTime) {
          document.querySelector('[data-step="1"]').classList.add('active');
        } else if (!hasChart) {
          document.querySelector('[data-step="1"]').classList.add('completed');
          document.querySelector('[data-step="2"]').classList.add('active');
        } else {
          document.querySelector('[data-step="1"]').classList.add('completed');
          document.querySelector('[data-step="2"]').classList.add('completed');
          document.querySelector('[data-step="3"]').classList.add('active');
        }
      }

      // ========== ç”Ÿæˆåœ–è¡¨ ==========
      async generateCharts() {
        if (this.state.selectedTimes.size === 0) {
          this.showToast('è«‹å…ˆé¸æ“‡æ™‚é–“ç¯„åœ', 'error');
          return;
        }

        const tasks = [];
        Object.entries(this.state.selectedCharts).forEach(([chartId, types]) => {
          if (types.new) tasks.push({ chartId, dataType: 'new' });
          if (types.cumulative) tasks.push({ chartId, dataType: 'cumulative' });
        });

        if (tasks.length === 0) {
          this.showToast('è«‹å…ˆé¸æ“‡åœ–è¡¨é¡å‹', 'error');
          return;
        }

        const container = document.getElementById('charts-container');
        const result = document.getElementById('charts-result');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><span>ç”Ÿæˆä¸­...</span></div>';
        result.style.display = 'block';

        // éŠ·æ¯€èˆŠåœ–è¡¨
        Object.values(this.chartInstances).forEach(c => c.destroy());
        this.chartInstances = {};
        this.state.charts = [];

        try {
          for (const task of tasks) {
            const data = await this.fetchChartData(task.chartId, task.dataType);
            if (data) this.state.charts.push(data);
          }

          this.renderCharts();
          this.showToast(`æˆåŠŸç”Ÿæˆ ${this.state.charts.length} å€‹åœ–è¡¨`, 'success');
        } catch (e) {
          console.error(e);
          this.showToast('ç”Ÿæˆåœ–è¡¨å¤±æ•—', 'error');
        }
      }

      async fetchChartData(chartType, dataType) {
        try {
          const res = await fetch('/api/chart-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chartType,
              timeSelections: [...this.state.selectedTimes],
              timeMode: this.state.timeMode,
              dataType
            })
          });
          const json = await res.json();
          return json.success ? json.data : this.generateMockData(chartType, dataType);
        } catch (e) {
          return this.generateMockData(chartType, dataType);
        }
      }

      generateMockData(chartType, dataType) {
        const labels = [...this.state.selectedTimes].sort();
        const configs = {
          chart0: ['ç¸½è¨ˆ'],
          chart1: ['æ•™å¸«', 'å­¸ç”Ÿ', 'ç ”ç©¶å“¡', 'å…¶ä»–'],
          chart2: ['è‡ºå¤§æ•™å¸«', 'è‡ºå¤§å­¸ç”Ÿ', 'ç ”ç©¶å“¡'],
          chart3: ['å°ˆä»»æ•™å¸«', 'å…¼ä»»æ•™å¸«', 'å°ˆæ¡ˆæ•™å¸«', 'è‡¨åºŠæ•™å¸«'],
          chart4: ['æ•™æˆ', 'å‰¯æ•™æˆ', 'åŠ©ç†æ•™æˆ', 'è¬›å¸«'],
          chart5: ['æ•™æˆ', 'å‰¯æ•™æˆ', 'åŠ©ç†æ•™æˆ', 'è¬›å¸«'],
          chart6: ['æ•™æˆ', 'å‰¯æ•™æˆ', 'åŠ©ç†æ•™æˆ', 'è¬›å¸«'],
          chart7: ['æ•™æˆ', 'å‰¯æ•™æˆ', 'åŠ©ç†æ•™æˆ', 'è¬›å¸«'],
          chart8: ['å¤§å­¸ç”Ÿ', 'ç ”ç©¶ç”Ÿ', 'åšå£«ç”Ÿ'],
          chart9: ['é†«å­¸é™¢', 'å·¥å­¸é™¢', 'ç†å­¸é™¢', 'ç®¡ç†å­¸é™¢', 'å…¶ä»–'],
          chart10: ['é†«å­¸é™¢', 'å·¥å­¸é™¢', 'ç†å­¸é™¢', 'ç®¡ç†å­¸é™¢', 'å…¶ä»–'],
          chart11: ['é†«å­¸é™¢', 'å·¥å­¸é™¢', 'ç†å­¸é™¢', 'ç®¡ç†å­¸é™¢', 'å…¶ä»–']
        };

        const cats = configs[chartType] || ['é¡åˆ¥'];
        const datasets = cats.map(cat => {
          let data;
          if (dataType === 'cumulative') {
            let cum = 0;
            data = labels.map(() => { cum += Math.floor(Math.random() * 20) + 5; return cum; });
          } else {
            data = labels.map(() => Math.floor(Math.random() * 30) + 5);
          }
          return { label: cat, data };
        });

        const names = {
          chart0: 'ç¸½å ±åäººæ•¸', chart1: 'æ ¡å…§å¤–å ±åè€…', chart2: 'å°å¤§å ±åè€…',
          chart3: 'æ•™å¸«æ‰€æœ‰è·ç´š', chart4: 'å°ˆä»»æ•™å¸«è·ç´š', chart5: 'å…¼ä»»æ•™å¸«è·ç´š',
          chart6: 'å°ˆæ¡ˆæ•™å¸«è·ç´š', chart7: 'è‡¨åºŠæ•™å¸«è·ç´š', chart8: 'å­¸ç”Ÿæ‰€æœ‰è·ç´š',
          chart9: 'æ•™å¸«å­¸é™¢', chart10: 'å­¸ç”Ÿå­¸é™¢', chart11: 'æ•™å¸«èˆ‡å­¸ç”Ÿå­¸é™¢'
        };

        const suffix = dataType === 'cumulative' ? 'ç´¯è¨ˆåˆ†å¸ƒ' : 'åˆ†å¸ƒ';
        return {
          title: `${names[chartType]}${suffix}`,
          chartType: labels.length === 1 ? 'pie' : (chartType === 'chart0' ? 'line' : 'bar'),
          labels,
          datasets
        };
      }

      // ========== æ¸²æŸ“åœ–è¡¨ ==========
      renderCharts() {
        const container = document.getElementById('charts-container');
        container.innerHTML = '';

        this.state.charts.forEach((chart, i) => {
          const card = document.createElement('div');
          card.className = 'chart-card';
          card.innerHTML = `
            <h3>${chart.title}</h3>
            <div class="chart-wrapper">
              <canvas id="chart-${i}"></canvas>
            </div>
          `;
          container.appendChild(card);

          const ctx = document.getElementById(`chart-${i}`).getContext('2d');
          const datasets = chart.datasets.map((ds, j) => ({
            ...ds,
            backgroundColor: chart.chartType === 'pie'
              ? chart.datasets.map((_, k) => this.colors[k % this.colors.length])
              : this.colors[j % this.colors.length] + (chart.chartType === 'line' ? '33' : ''),
            borderColor: this.colors[j % this.colors.length],
            borderWidth: chart.chartType === 'line' ? 2 : 1,
            fill: chart.chartType === 'line',
            tension: 0.3
          }));

          this.chartInstances[i] = new Chart(ctx, {
            type: chart.chartType === 'pie' ? 'pie' : chart.chartType,
            data: { labels: chart.labels, datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: chart.chartType === 'pie' ? 'right' : 'top' }
              },
              scales: chart.chartType === 'pie' ? {} : {
                y: { beginAtZero: true }
              }
            }
          });
        });
      }

      // ========== ä¸‹è¼‰ ==========
      async downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        // æ¨™é¡Œé 
        pdf.setFontSize(24);
        pdf.text('ACE å­¸ç¿’è€…åœ–è¡¨å ±å‘Š', 105, 40, { align: 'center' });
        pdf.setFontSize(12);
        pdf.text(`ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`, 105, 55, { align: 'center' });
        pdf.text(`å…± ${this.state.charts.length} å€‹åœ–è¡¨`, 105, 65, { align: 'center' });

        // æ¯å€‹åœ–è¡¨ä¸€é 
        for (let i = 0; i < this.state.charts.length; i++) {
          pdf.addPage();
          const canvas = document.getElementById(`chart-${i}`);
          const imgData = canvas.toDataURL('image/png', 1.0);
          pdf.setFontSize(14);
          pdf.text(this.state.charts[i].title, 105, 20, { align: 'center' });
          pdf.addImage(imgData, 'PNG', 15, 30, 180, 120);
        }

        pdf.save(`ACEå ±å‘Š_${new Date().toISOString().slice(0, 10)}.pdf`);
        this.showToast('PDF ä¸‹è¼‰å®Œæˆ', 'success');
      }

      async downloadPNG() {
        const zip = new JSZip();

        for (let i = 0; i < this.state.charts.length; i++) {
          const canvas = document.getElementById(`chart-${i}`);
          const dataUrl = canvas.toDataURL('image/png');
          const base64 = dataUrl.split(',')[1];
          zip.file(`${this.state.charts[i].title}.png`, base64, { base64: true });
        }

        const content = await zip.generateAsync({ type: 'blob' });
        saveAs(content, `ACEåœ–è¡¨_${new Date().toISOString().slice(0, 10)}.zip`);
        this.showToast('PNG ä¸‹è¼‰å®Œæˆ', 'success');
      }

      // ========== è¯çµ¡è¡¨å–® ==========
      handleContact(e) {
        e.preventDefault();
        const name = document.getElementById('contact-name').value;
        const email = document.getElementById('contact-email').value;
        const subject = document.getElementById('contact-subject').value;
        const message = document.getElementById('contact-message').value;

        const mailto = `mailto:tingin0615@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(
          `å¯„ä»¶äººï¼š${name}\nå›è¦†éƒµç®±ï¼š${email}\n\n${message}`
        )}`;
        window.location.href = mailto;
        this.showToast('å·²é–‹å•Ÿéƒµä»¶å®¢æˆ¶ç«¯', 'success');
        e.target.reset();
      }

      // ========== Toast ==========
      showToast(message, type = 'info') {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
      }
    }

    // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    new ACEDashboard();
  </script>
</body>
</html>
